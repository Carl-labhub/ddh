---
title: "Dep Map analysis pathway generator"
output:
  pdf_document:
    toc: TRUE
params:
  release: "19Q3"
---
This document loads the data generated in depmap_generate, and then attemps to generate pathway data for top and bottom correlated genes, generate the plots, and store them in three distince list-column dataframes:  

master_postive  
master_negative  
master_plots  

##Load libraries
```{r load_block, echo=TRUE, message=FALSE, warning=FALSE}
#not sure which exactly of these I need
library(tidyverse)
library(lubridate)
library(here)
library(readxl)
library(janitor)
library(feather)
library(corrr)
library(purrr)
library(viridis)
library(enrichR)
library(glue)
library(moderndive)
library(rmarkdown)
library(gridExtra)
library(knitr)
library(pander)
library(vroom)
library(beepr) #long analysis; get some coffee, and comeback when ready

#clear environment
#rm(list=ls()) 

#how long?
start_time <- Sys.time()
```

#define functions
```{r}
#pathway enrichment analysis loop function
enrichr_loop <- function(gene_list, databases){
  if(is_empty(gene_list)){
    flat_complete <- NULL
    return(flat_complete)
  } else {
    flat_complete <- as_tibble()
    for(lib in databases){
      enriched <- enrichr(gene_list, lib)
      
      flat <- flatten_dfc(enriched) %>% 
        mutate(enrichr = lib)
      
      flat_complete <- flat_complete %>% 
        bind_rows(flat)
    }
    flat_complete <- flat_complete %>% 
      arrange(Adjusted.P.value) 
      #select(enrichr, Term, Overlap)
    
    flat_complete$enrichr <- str_replace_all(flat_complete$enrichr, "\\_", " ")
    flat_complete$Term <- str_replace_all(flat_complete$Term, "\\_", " ")
    return(flat_complete)
  }
}
```

##import
```{r import}
##BROAD
achilles <- read_feather(here::here("data", paste0(params$release, "_achilles.feather")))
achilles_long <- achilles %>% gather("gene", "dep_score", -X1)
achilles_cor <- read_feather(here::here("data", paste0(params$release, "_achilles_cor.feather"))) 
class(achilles_cor) <- c("cor_df", "tbl_df", "tbl", "data.frame") #define class so functions (eg focus) can work on reloaded df

achilles_cor_long <- achilles_cor %>% 
  stretch() #observations across 3 variables (x, y, r); longest step, but cannot get cor_long.feather to load properly

#EXPRESSION(BROAD), need this to get cell line names
expression_id <- read_feather(here::here("data", paste0(params$release, "_expression_id.feather"))) 

expression_join <- expression_id %>% 
  rename(X1 = dep_map_id) %>% 
  select(X1, stripped_cell_line_name, lineage)

gene_summary <- read_feather(path = here::here("data", "gene_summary.feather"))
```

#stats; import saved files generated in depmap_generate_stats.Rmd
Expecting mean ~0, and upper/lower ~+/- 0.2
```{r permutation}
sd_threshold <- readRDS(file = here::here("data", "sd_threshold.rds"))
achilles_lower <- readRDS(file = here::here("data", "achilles_lower.rds"))
achilles_upper <- readRDS(file = here::here("data", "achilles_upper.rds"))
mean_virtual_achilles <- readRDS(file = here::here("data", "mean_virtual_achilles.rds"))
sd_virtual_achilles <- readRDS(file = here::here("data", "sd_virtual_achilles.rds"))
```

#setup containers
```{r eval=FALSE}
#running this overwrites any master tables in the environment
master_positive <- tibble(
  fav_gene = character(), 
  data = list()
)
master_negative <- tibble(
  fav_gene = character(), 
  data = list()
)
master_plots <- tibble(
  fav_gene = character(), 
  plot1 = list(), 
  plot2 = list()
)
master_top_table <- tibble(
  fav_gene = character(), 
  data = list()
)
master_bottom_table <- tibble(
  fav_gene = character(), 
  data = list()
)
```

#temp data groups 
```{r}
purine <- c("ADSL", "ADSS1", "ADSS2", "AK1", "AK2", "AK3", "AK4", "AK5", "ATIC", "GART", "GMPS", "IMPDH1", "IMPDH2", "PAICS", "PFAS", "PPAT", "PRPS1", "PRPS1L1", "PRPS2", "TAF9")
pyrimidine <- c("CAD", "CMPK1", "CMPK2", "CTPS1", "CTPS2", "DHODH", "NME1", "NME2", "NME3", "NME4", "NME6", "UMPS")
```

#small sample
```{r}
sample <- sample(names(achilles_cor), size = 10)
gene_group <- sample
```


#master_table_top
```{r}
for (fav_gene in gene_group) {
  message("Top dep tables for ", fav_gene)
    dep_top <- achilles_cor %>% 
      focus(fav_gene) %>% 
      arrange(desc(.[[2]])) %>% #use column index
      filter(.[[2]] > achilles_upper) %>% #formerly top_n(20), but changed to mean +/- 3sd
      rename(approved_symbol = rowname) %>% 
      left_join(gene_summary, by = "approved_symbol") %>% 
      select(approved_symbol, approved_name, fav_gene) %>% 
      rename(gene = approved_symbol, name = approved_name, r2 = fav_gene)
    
    top_table <- dep_top %>% 
      mutate(fav_gene = fav_gene) %>% 
      group_by(fav_gene) %>% 
      nest()
    
    master_top_table <- master_top_table %>% 
      bind_rows(top_table)
}

save(master_top_table, file=here::here("data", "master_top_table.RData"))
beep(sound = 8) #because mario is awesome
```

#master_table_bottom
```{r}
gene_group <- sample #defined in first block (line 318)

for (fav_gene in gene_group) {
  message("Bottom dep tables for ", fav_gene)
    dep_bottom <- achilles_cor %>% 
      focus(fav_gene) %>% 
      arrange(.[[2]]) %>% #use column index
      filter(.[[2]] < achilles_lower) %>% #formerly top_n(20), but changed to mean +/- 3sd
      rename(approved_symbol = rowname) %>% 
      left_join(gene_summary, by = "approved_symbol") %>% 
      select(approved_symbol, approved_name, fav_gene) %>% 
      rename(gene = approved_symbol, name = approved_name, r2 = fav_gene)
    
    bottom_table <- dep_bottom %>% 
      mutate(fav_gene = fav_gene) %>% 
      group_by(fav_gene) %>% 
      nest()
    
    master_bottom_table <- master_bottom_table %>% 
      bind_rows(bottom_table)
}

save(master_bottom_table, file=here::here("data", "master_bottom_table.RData"))
beep(sound = 8) #because mario is awesome
```

#master_plots
```{r}
gene_group <- sample #defined in first block (line 318)

for (fav_gene in gene_group) {
  #plot setup
    target_achilles <- achilles_long %>% 
      filter(gene == fav_gene) %>% 
      left_join(expression_join, by = "X1") %>% 
      select(stripped_cell_line_name, lineage, dep_score)
    
    target_achilles_top <- target_achilles %>% 
      top_frac(dep_score, n = 0.01)
    
    target_achilles_bottom <- target_achilles %>% 
      top_frac(dep_score, n = -0.01) %>% 
      arrange(dep_score)
    
    #plot1
    dep_plot1 <- ggplot(target_achilles) +
      geom_histogram(aes(x = dep_score), binwidth = 0.25, color = "lightgray") +
      labs(x = "Dependency Score (binned)") + 
      theme_light()
    
    #plot2
    dep_plot2 <- ggplot(target_achilles) +
      geom_point(aes(x = fct_rev(fct_reorder(target_achilles$stripped_cell_line_name,  target_achilles$dep_score, .desc = TRUE)), y = dep_score)) + #is target achilles in here?
      labs(x = "Cell Lines", y = "Dependency Score") +
      geom_hline(yintercept = mean_virtual_achilles) +
      geom_hline(yintercept = achilles_upper, linetype="dashed") +
      geom_hline(yintercept = achilles_lower, linetype="dashed") +
      geom_hline(yintercept = 0) +
      geom_point(data = target_achilles_top, aes(x = stripped_cell_line_name, y = dep_score), color = "red") +
      geom_point(data = target_achilles_bottom, aes(x = stripped_cell_line_name, y = dep_score), color = "red") +
      theme_light() +
      theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + # axis.title.x=element_blank()
      NULL
    
    #place objects into list columns
    plot1 <- list(dep_plot1)
    plot2 <- list(dep_plot2)
    plots <- tibble(fav_gene, plot1, plot2)
    
    master_plots <- master_plots %>% 
      bind_rows(plots)
}
save(master_plots, file=here::here("data", "master_plots.RData"))
beep(sound = 8) #because mario is awesome
```

#master_positive
Generate list on the fly (redundant with above), so it can be parallel, and not rely on one of the other chunks.
```{r}
gene_group <- sample #defined in first block (line 318)

for (fav_gene in gene_group) {
 message("Top pathway enrichment analyses for ", fav_gene)
    flat_top_complete <- achilles_cor %>% 
      focus(fav_gene) %>% 
      arrange(desc(.[[2]])) %>% #use column index
      filter(.[[2]] > achilles_upper) %>% #formerly top_n(20), but changed to mean +/- 3sd
      rename(approved_symbol = rowname) %>% 
      left_join(gene_summary, by = "approved_symbol") %>% 
      select(approved_symbol, approved_name, fav_gene) %>% 
      rename(gene = approved_symbol, name = approved_name, r2 = fav_gene) %>%
      pull("gene") %>% 
      c(fav_gene, .) %>% 
      enrichr_loop(., focused_lib) %>%  #added small here
      arrange(Adjusted.P.value) %>% 
      slice(1:100)
    
    positive <- flat_top_complete  %>% 
      mutate(fav_gene = fav_gene) %>% 
      group_by(fav_gene) %>% 
      nest()
    
    master_positive <- master_positive %>% 
      bind_rows(positive)
    
}

save(master_positive, file=here::here("data", "master_positive.RData"))
beep(sound = 8) #because mario is awesome
```

#master_negative
```{r}
gene_group <- sample #defined in first block (line 318)

for (fav_gene in gene_group) {
message("Bottom pathway enrichment analyses for ", fav_gene)
    flat_bottom_complete <- achilles_cor %>% 
      focus(fav_gene) %>% 
      arrange(.[[2]]) %>% #use column index
      filter(.[[2]] < achilles_lower) %>% #formerly top_n(20), but changed to mean +/- 3sd
      rename(approved_symbol = rowname) %>% 
      left_join(gene_summary, by = "approved_symbol") %>% 
      select(approved_symbol, approved_name, fav_gene) %>% 
      rename(gene = approved_symbol, name = approved_name, r2 = fav_gene) %>%
      pull("gene") %>% 
      enrichr_loop(., focused_lib) %>%  #added small here
      arrange(Adjusted.P.value) %>% 
      slice(1:100)
    
    negative <- flat_bottom_complete %>% 
      mutate(fav_gene = fav_gene) %>% 
      group_by(fav_gene) %>% 
      nest()
    
    master_negative <- master_negative %>% 
      bind_rows(negative)
}
save(master_negative, file=here::here("data", "master_negative.RData"))
beep(sound = 8) #because mario is awesome
```

#load Rdata
```{r}
load(file=here::here("data", "master_bottom_table.RData"))
load(file=here::here("data", "master_top_table.RData"))
load(file=here::here("data", "master_plots.RData"))
load(file=here::here("data", "master_positive.RData"))
load(file=here::here("data", "master_negative.RData"))
```

#test retreival to set objects
```{r}
#wrap this in if_else for if it's found v. not?
fav_gene <- c("SETD1B")

fav_gene_summary <- gene_summary %>% 
      filter(approved_symbol == fav_gene)

dep_top <- master_top_table %>% 
  filter(fav_gene == !!fav_gene) %>% 
  unnest(data) %>% 
  select(-fav_gene) %>% 
  arrange(desc(r2))

dep_bottom <- master_bottom_table %>% 
  filter(fav_gene == !!fav_gene) %>% 
  unnest(data) %>% 
  select(-fav_gene) %>% 
  arrange(r2)

flat_top_complete <- master_positive %>% 
  filter(fav_gene == !!fav_gene) %>% 
  unnest(data) %>% 
  select(-fav_gene) %>% 
  arrange(Adjusted.P.value)

flat_bottom_complete <- master_negative %>% 
  filter(fav_gene == !!fav_gene) %>% 
  unnest(data) %>% 
  select(-fav_gene) %>% 
  arrange(Adjusted.P.value)

dep_plot1 <- master_plots %>% 
  filter(fav_gene == !!fav_gene) %>% 
  pluck("plot1")

dep_plot2 <- master_plots %>% 
  filter(fav_gene == !!fav_gene) %>% 
  pluck("plot2")

```

# test generation of report
```{r}
fav_gene <- c("SETD1B")

if(fav_gene %in% names(achilles_cor) == 1){ #this code checks to see if the gene is in the analysis, and if not, skips
  fav_gene_summary <- gene_summary %>% 
    filter(approved_symbol == fav_gene)
  
  dep_top <- master_top_table %>% 
    filter(fav_gene == !!fav_gene) %>% 
    unnest(data) %>% 
    select(-fav_gene) %>% 
    arrange(desc(r2))
  
  dep_bottom <- master_bottom_table %>% 
    filter(fav_gene == !!fav_gene) %>% 
    unnest(data) %>% 
    select(-fav_gene) %>% 
    arrange(r2)
  
  flat_top_complete <- master_positive %>% 
    filter(fav_gene == !!fav_gene) %>% 
    unnest(data) %>% 
    select(-fav_gene) %>% 
    arrange(Adjusted.P.value)
  
  flat_bottom_complete <- master_negative %>% 
    filter(fav_gene == !!fav_gene) %>% 
    unnest(data) %>% 
    select(-fav_gene) %>% 
    arrange(Adjusted.P.value)
  
  dep_plot1 <- master_plots %>% 
    filter(fav_gene == !!fav_gene) %>% 
    pluck("plot1")
  
  dep_plot2 <- master_plots %>% 
    filter(fav_gene == !!fav_gene) %>% 
    pluck("plot2")
  
  #render output
  render("report_depmap_complete.rmd", output_dir = here::here("results"), output_file = paste0(fav_gene, '_depmap.pdf'))
} else {
  fav_gene_summary <- gene_summary %>% 
    filter(approved_symbol == fav_gene)
  
  #render output
  render("report_dummy_depmap.rmd", output_dir = here::here("results"), output_file = paste0(fav_gene, '_depmap.pdf'))
}

#beep(sound = 8) 
#because mario is awesome
```

#how long?
```{r}
end_time <- Sys.time()
time_taken <- round(as.duration(start_time %--% end_time)/dminutes(1), digits = 1)
print(time_taken)
```
Approximate time to run was `r time_taken` minutes.

#print Session information for provenance and reproducibility
```{r}
utils:::print.sessionInfo(sessionInfo()[-8]) 
#You can remove an item from sessionInfo(), which is a list with a class attribute, by printing the resulting object omitting one of the list items (omitted list of packages installed, but not loaded)

```
#stamp
```{r}
stamp("Data updated December 31, 1979")(now())
```

#beep
```{r}
beep(sound = 8) #because mario is awesome
```



